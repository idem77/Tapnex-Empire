name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30   # pura job max 30 min chalega

    steps:
      # Checkout repo
      - uses: actions/checkout@v3

      # Setup JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      # Install required SDK packages
      - name: Install emulator system image
        run: |
          sdkmanager --install "platform-tools" "emulator" "system-images;android-30;google_apis;x86_64"
          yes | sdkmanager --licenses
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

      # Build debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug

      # Create AVD
      - name: Create AVD
        run: avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64" --device "pixel"

      # Start Emulator (with 5 min timeout)
      - name: Start Emulator
        run: |
          emulator -avd test -no-window -no-audio -no-snapshot -gpu swiftshader_indirect &
          adb wait-for-device
          # Wait max 5 min for boot
          timeout 300 sh -c "until adb shell getprop sys.boot_completed | grep 1; do sleep 5; done" || {
            echo "❌ Emulator failed to boot in time";
            exit 1;
          }
          adb shell input keyevent 82

      # Install APK
      - name: Install APK on Emulator
        run: adb install -r app/build/outputs/apk/debug/app-debug.apk

      # Run app and capture logs
      - name: Run app and capture logs
        run: |
          adb shell am start -n com.tapnexempire/.MainActivity || true
          sleep 20
          adb logcat -d > logcat.txt || echo "No logcat available"

      # Upload logs + APK as artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tapnex-artifacts
          path: |
            app/build/outputs/apk/debug/app-debug.apk
            logcat.txt
